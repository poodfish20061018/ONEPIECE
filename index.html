<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>七日世界</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <style>
    @font-face {
      font-family: 'XiaoZhuan';
      src: url('SimKai.ttf') format('truetype');
    }
    
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      width: 100vw;
      font-family: 'XiaoZhuan', KaiTi, serif;
      background: #87ceeb;
      overflow-x: hidden;
      position: relative;
      -webkit-overflow-scrolling: touch;
    }
    
    .bg-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-color: #87ceeb;
      transition: background-image 0.5s;
    }
    
    .bg-container::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.1); /* 添加半透明遮罩提高文字可读性 */
    }
    
    .container {
      position: relative;
      z-index: 1;
      margin: 5vw auto 3vw auto;
      max-width: 98vw;
      padding: 2vw 2vw 1vw 2vw;
      animation: float 4s infinite ease-in-out;
    }
    
    @keyframes float {
      0%,100%{transform:translateY(0)}
      50%{transform:translateY(-12px)}
    }
    
    .flame-title {
      position: relative;
      text-align: center;
      margin-bottom: 22px;
      margin-top: 20px;
      height: 70px;
      width: 100%;
      min-width: 180px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .flame-svg {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 120%;
      height: 160%;
      transform: translate(-50%,-68%);
      pointer-events: none;
      z-index: 0;
      opacity: 0.98;
    }
    
    /* 动态 SVG 动画 */
    .flame-path1 {
      stroke: #fff;
      stroke-width: 13;
      fill: none;
      opacity: 0.93;
      stroke-linecap: round;
      stroke-linejoin: round;
      animation: flameMove1 1.1s infinite alternate;
    }
    
    .flame-path2 {
      stroke: #fff;
      stroke-width: 9;
      fill: none;
      opacity: 0.70;
      stroke-linecap: round;
      stroke-linejoin: round;
      animation: flameMove2 1.6s infinite alternate;
    }
    
    .flame-path3 {
      stroke: #fff;
      stroke-width: 7;
      fill: none;
      opacity: 0.53;
      stroke-linecap: round;
      stroke-linejoin: round;
      animation: flameMove3 1.3s infinite alternate;
    }
    
    @keyframes flameMove1 {
      0% { stroke-dasharray: 180 30; stroke-dashoffset: 0; }
      100% { stroke-dasharray: 120 60; stroke-dashoffset: -18;}
    }
    
    @keyframes flameMove2 {
      0% { stroke-dasharray: 100 30; stroke-dashoffset: 0; }
      100% { stroke-dasharray: 80 40; stroke-dashoffset: -11;}
    }
    
    @keyframes flameMove3 {
      0% { stroke-dasharray: 60 22; stroke-dashoffset: 0;}
      100% { stroke-dasharray: 46 36; stroke-dashoffset: -10;}
    }
    
    /* 雷电线 */
    .lightning {
      stroke: #222;
      stroke-width: 3;
      fill: none;
      opacity: 0.8;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 1px #222);
      animation: lightningMove 0.7s infinite alternate;
    }
    
    .lightning2 {
      stroke: #222;
      stroke-width: 2.2;
      opacity: 0.7;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 0 1px #222);
      animation: lightningMove2 1.1s infinite alternate;
    }
    
    @keyframes lightningMove {
      0% { stroke-dasharray: 16 4; stroke-dashoffset: 0; }
      100% { stroke-dasharray: 10 10; stroke-dashoffset: -6;}
    }
    
    @keyframes lightningMove2 {
      0% { stroke-dasharray: 12 3; stroke-dashoffset: 0; }
      100% { stroke-dasharray: 7 8; stroke-dashoffset: -5;}
    }
    
    /* 黑色小点动画 */
    .dot {
      fill: #222;
      opacity: 0.75;
      animation: dotFlicker 0.9s infinite alternate;
    }
    
    .dot2 {
      fill: #222;
      opacity: 0.55;
      animation: dotFlicker2 0.6s infinite alternate;
    }
    
    .dot3 {
      fill: #222;
      opacity: 0.45;
      animation: dotFlicker3 1.2s infinite alternate;
    }
    
    @keyframes dotFlicker {
      0% { r: 2.6; opacity: 0.75;}
      100% { r: 4.2; opacity: 0.4;}
    }
    
    @keyframes dotFlicker2 {
      0% { r: 2.2; opacity: 0.55;}
      100% { r: 2.9; opacity: 0.7;}
    }
    
    @keyframes dotFlicker3 {
      0% { r: 1.7; opacity: 0.45;}
      100% { r: 2.6; opacity: 0.3;}
    }
    
    .title-text {
      position: relative;
      z-index: 1;
      font-family: 'XiaoZhuan', KaiTi, serif;
      font-size: 3em;
      letter-spacing: 10px;
      color: #fff;
      text-shadow:
        0 0 14px #fff,
        0 0 28px #fff,
        0 0 48px #fff;
      filter: brightness(1.19);
      font-weight: bold;
      line-height: 1.18;
      display: inline-block;
    }
    
    .table-wrap {
      border-radius: 0;
      overflow-x: auto;
      background: transparent;
      box-shadow: none;
      margin-bottom: 0;
      -webkit-overflow-scrolling: touch;
    }
    
    table {
      margin: 0 auto;
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 1.5em;
      font-family: 'XiaoZhuan', KaiTi, serif;
      background: transparent;
      box-shadow: none;
    }
    
    th, td {
      border: 1px solid #e4e4e4;
      color: #fff;
      min-width: 36px;
      height: 34px;
      padding: 2px;
      text-align: center;
      vertical-align: middle;
      position: relative;
      background: transparent;
      font-size: 0.98em;
      border-radius: 0;
      box-shadow: none;
      font-weight: normal;
      text-shadow:
        0 0 10px #fff,
        0 0 22px #fff;
    }
    
    th {
      color: #fff;
      font-weight: bold;
      border-radius: 0;
      box-shadow: none;
    }
    
    td.selected {
      background: linear-gradient(135deg,#82A68488 60%,#DAA0B488 100%);
      box-shadow: 0 0 12px #fff;
      border: 2px dashed #fff;
    }
    
    td textarea {
      width: 98%;
      height: 90%;
      border: none;
      background: transparent;
      resize: none;
      font-size: 0.98em;
      font-family: 'XiaoZhuan', KaiTi, serif;
      outline: none;
      text-align: center;
      color: #fff;
      background: transparent;
      box-shadow: none;
      text-shadow:
        0 0 10px #fff,
        0 0 22px #fff;
      -webkit-user-select: text;
      user-select: text;
    }
    
    .actions {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-wrap: wrap;
      z-index: 2;
    }
    
    .actions button, .actions label {
      font-size: 1.1em;
      font-family: 'XiaoZhuan', KaiTi, serif;
      border-radius: 10px;
      border: 1.2px solid #fff;
      background: rgba(255,255,255,0.09);
      color: #fff;
      box-shadow: 0 2px 12px #fff4;
      padding: 8px 18px;
      text-shadow:
        0 0 14px #fff,
        0 0 22px #fff;
      margin: 2px;
      transition: background 0.3s, color 0.3s;
      font-weight: bold;
      cursor: pointer;
    }
    
    .actions button:hover, .actions label:hover {
      background: rgba(255,255,255,0.18);
      color: #fff;
    }
    
    .merge-btn {
      position: fixed;
      left: 16px;
      bottom: 38px;
      z-index: 99;
      font-size: 1em;
      padding: 8px 22px;
      background: linear-gradient(90deg,#82A684,#DAA0B4,#5CB4CD);
      color: #fff;
      border: none;
      border-radius: 14px;
      box-shadow: 0 4px 12px #e9e9f4;
      display: none;
      font-family: 'XiaoZhuan', KaiTi, serif;
      animation: float 3s infinite;
      border: 1px solid #fff;
      text-shadow:
        0 0 12px #fff,
        0 0 24px #fff;
    }
    
    .settings-modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      background: rgba(30,30,30,0.96);
      border-radius: 16px;
      box-shadow: 0 4px 24px #fff8;
      padding: 28px 18px 16px 18px;
      z-index: 999;
      min-width: 220px;
      color: #fff;
      text-align: center;
      display: none;
    }
    
    .settings-modal label, .settings-modal input {
      font-size: 1.07em;
      font-family: 'XiaoZhuan', KaiTi, serif;
      color: #fff;
      display: block;
      margin-bottom: 18px;
    }
    
    .settings-modal .close-btn {
      margin-top: 8px;
      font-size: 1.08em;
      background: #fff2;
      color: #fff;
      border: 1px solid #fff;
      border-radius: 10px;
      padding: 6px 16px;
      text-shadow:
        0 0 10px #fff,
        0 0 18px #fff;
      cursor: pointer;
    }
    
    /* 闹钟模态框样式 */
    .alarm-modal {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      background: rgba(30,30,30,0.96);
      border-radius: 16px;
      box-shadow: 0 4px 24px #fff8;
      padding: 28px 18px 16px 18px;
      z-index: 999;
      min-width: 250px;
      color: #fff;
      text-align: center;
      display: none;
    }
    
    .alarm-modal h3 {
      margin-top: 0;
      font-size: 1.3em;
    }
    
    .alarm-modal .time-inputs {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }
    
    .alarm-modal input {
      width: 60px;
      text-align: center;
      background: rgba(255,255,255,0.1);
      border: 1px solid #fff;
      border-radius: 5px;
      color: #fff;
      font-size: 1.2em;
      padding: 5px;
    }
    
    .alarm-modal .colon {
      font-size: 1.5em;
      margin: 0 5px;
    }
    
    .alarm-modal .alarm-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .alarm-modal .alarm-buttons button {
      font-size: 1em;
      padding: 8px 15px;
      border: 1px solid #fff;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
    }
    
    .alarm-status {
      margin-top: 10px;
      font-size: 0.9em;
      color: #ffcc00;
    }
    
    /* iOS 特定优化 */
    @supports (-webkit-touch-callout: none) {
      .bg-container {
        position: fixed;
        height: 100vh;
        background-attachment: scroll;
      }
      
      body {
        background-attachment: scroll;
      }
    }
    
    @media (max-width: 600px) {
      .container {margin: 2vw auto; padding: 2vw 1vw;}
      table { font-size: 0.94em; }
      th, td { min-width: 20px; height: 22px; }
      .title-text { font-size: 1.7em; }
      .flame-title { height: 36px; min-width: 90px;}
      .settings-modal {min-width: 120px;}
      .alarm-modal {min-width: 200px; padding: 20px 15px;}
      .flame-svg { width: 100%; height: 120%; }
      .actions { gap: 8px; }
      .actions button, .actions label { font-size: 0.9em; padding: 6px 12px; }
      .merge-btn { left: 10px; bottom: 20px; font-size: 0.85em; padding: 6px 14px; }
      .alarm-modal input { width: 50px; font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="bg-container" id="bgContainer"></div>
  
  <div class="container">
    <div class="flame-title">
      <svg class="flame-svg" viewBox="0 0 120 40">
        <!-- 白色火焰（不对称多路径） -->
        <path class="flame-path1" d="M10,30 Q30,8 60,28 Q100,2 110,30" />
        <path class="flame-path2" d="M18,32 Q38,15 70,30 Q90,10 105,32" />
        <path class="flame-path3" d="M22,37 Q50,20 80,35 Q105,20 110,38" />
        <!-- 黑色雷电（不对称+动态） -->
        <polyline class="lightning" points="20,34 24,26 28,34 32,28 36,34" />
        <polyline class="lightning2" points="100,34 96,28 92,34 88,27 85,34" />
        <!-- 小黑点 -->
        <circle class="dot" cx="30" cy="16" r="3"/>
        <circle class="dot2" cx="53" cy="9" r="2"/>
        <circle class="dot3" cx="75" cy="14" r="2"/>
        <circle class="dot" cx="98" cy="6" r="2.4"/>
        <circle class="dot2" cx="25" cy="37" r="2"/>
        <circle class="dot3" cx="108" cy="35" r="1.6"/>
      </svg>
      <div class="title-text">七日世界</div>
    </div>
    <div class="table-wrap" id="tableWrap"></div>
    <div class="actions">
      <button onclick="openSettings()">设置</button>
      <button onclick="openAlarmModal()">闹钟设置</button>
      <button onclick="setVibrate()">震动提醒</button>
      <button onclick="clearTable()">清空表格</button>
    </div>
    <button class="merge-btn" id="mergeBtn" onclick="mergeCells()">合并格子</button>
  </div>
  
  <div class="settings-modal" id="settingsModal">
    <label>
      更换壁纸
      <input type="file" id="bgFile" accept="image/*">
    </label>
    <label>
      上传铃声
      <input type="file" id="ringFile" accept="audio/*">
    </label>
    <button class="close-btn" onclick="closeSettings()">关闭</button>
  </div>
  
  <!-- 新增闹钟设置模态框 -->
  <div class="alarm-modal" id="alarmModal">
    <h3>设置闹钟</h3>
    <div class="time-inputs">
      <input type="number" id="alarmHour" min="0" max="23" placeholder="时">
      <span class="colon">:</span>
      <input type="number" id="alarmMinute" min="0" max="59" placeholder="分">
    </div>
    <div class="alarm-status" id="alarmStatus"></div>
    <div class="alarm-buttons">
      <button onclick="saveAlarm()">保存闹钟</button>
      <button onclick="clearAlarm()">清除闹钟</button>
      <button onclick="closeAlarmModal()">关闭</button>
    </div>
  </div>
  
  <audio id="audioPlayer" preload="auto"></audio>
  
  <script>
    // 表格参数
    const days = ['周一','周二','周三','周四','周五','周六','周日'];
    const hours = Array.from({length: 18}, (_,i) => i+7); // 7-24
    const tableData = JSON.parse(localStorage.getItem('planTable') || '{}');
    let selectedCells = [];
    let isLongPress = false, timer = null;
    let alarmTime = null; // 存储闹钟时间

    // 初始化
    function init() {
      setInitialBg();
      renderTable();
      loadAlarm();
    }

    function setInitialBg() {
      const bgImg = localStorage.getItem('bgImg');
      const bgContainer = document.getElementById('bgContainer');
      
      if (bgImg) {
        bgContainer.style.backgroundImage = `url('${bgImg}')`;
        bgContainer.style.backgroundSize = 'cover';
        bgContainer.style.backgroundPosition = 'center';
        bgContainer.style.backgroundRepeat = 'no-repeat';
      } else {
        bgContainer.style.background = "#87ceeb";
      }
    }
    
    function renderTable() {
      const wrap = document.getElementById('tableWrap');
      let html = `<table id="planTable"><tr><th>时间</th>`;
      days.forEach(day=>html+=`<th>${day}</th>`);
      html += `</tr>`;
      hours.forEach(h=>{
        html += `<tr><th>${h}:00</th>`;
        days.forEach((day,di)=>{
          let key = `${day}-${h}`;
          let cell = tableData[key]||{};
          let text = cell.text||'';
          let colspan = cell.colspan||1, rowspan = cell.rowspan||1;
          let isMerged = cell.merged||false;
          let mergedMark = (colspan>1||rowspan>1) ? `colspan="${colspan}" rowspan="${rowspan}"` : '';
          let style = isMerged?'display:none;':'';
          html += `<td ${mergedMark} style="${style}" data-key="${key}" onmousedown="cellMouseDown(event)" ontouchstart="cellMouseDown(event)">
            <textarea oninput="saveCell('${key}',this.value)" onfocus="this.select()">${text}</textarea>
          </td>`;
        });
        html += `</tr>`;
      });
      html += `</table>`;
      wrap.innerHTML = html;
      updateSelected();
    }

    function saveCell(key,val){
      if(!tableData[key])tableData[key]={};
      tableData[key].text = val;
      localStorage.setItem('planTable', JSON.stringify(tableData));
    }

    function clearTable(){
      if(confirm('确定要清空所有内容吗？')){
        localStorage.removeItem('planTable');
        location.reload();
      }
    }

    document.getElementById('bgFile').onchange = function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(evt){
          const bgContainer = document.getElementById('bgContainer');
          bgContainer.style.backgroundImage = `url('${evt.target.result}')`;
          bgContainer.style.backgroundSize = 'cover';
          bgContainer.style.backgroundPosition = 'center';
          bgContainer.style.backgroundRepeat = 'no-repeat';
          localStorage.setItem('bgImg', evt.target.result);
        };
        reader.readAsDataURL(file);
      }
    };

    let ringSrc = localStorage.getItem('ringSrc');
    document.getElementById('ringFile').onchange = function(e){
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = function(evt){
          ringSrc = evt.target.result;
          localStorage.setItem('ringSrc', ringSrc);
          document.getElementById('audioPlayer').src = ringSrc;
        };
        reader.readAsDataURL(file);
      }
    };
    if(ringSrc) document.getElementById('audioPlayer').src = ringSrc;

    function cellMouseDown(e){
      e.preventDefault(); // 防止iOS上的默认行为
      let td = e.currentTarget;
      let key = td.dataset.key;
      isLongPress = false;
      timer = setTimeout(()=>{
        isLongPress = true;
        toggleSelect(key,td);
      }, 400);
      document.addEventListener('mouseup', clearLongPress);
      document.addEventListener('touchend', clearLongPress);
    }
    
    function clearLongPress(){
      clearTimeout(timer);
      document.removeEventListener('mouseup', clearLongPress);
      document.removeEventListener('touchend', clearLongPress);
    }
    
    function toggleSelect(key,td){
      if(selectedCells.includes(key)){
        selectedCells = selectedCells.filter(k=>k!==key);
        td.classList.remove('selected');
      }else{
        selectedCells.push(key);
        td.classList.add('selected');
      }
      document.getElementById('mergeBtn').style.display = selectedCells.length>1?'block':'none';
    }
    
    function updateSelected(){
      document.querySelectorAll('td').forEach(td=>{
        let key = td.dataset.key;
        if(selectedCells.includes(key)) td.classList.add('selected');
        else td.classList.remove('selected');
      });
      document.getElementById('mergeBtn').style.display = selectedCells.length>1?'block':'none';
    }
    
    function mergeCells(){
      if(selectedCells.length<2)return;
      let mainKey = selectedCells[0];
      let mainCell = tableData[mainKey]||{};
      let keys = [...selectedCells];
      let positions = keys.map(k=>{
        let [d,h]=k.split('-');
        return {d:days.indexOf(d),h:hours.indexOf(parseInt(h)), key:k};
      });
      let minD = Math.min(...positions.map(p=>p.d));
      let maxD = Math.max(...positions.map(p=>p.d));
      let minH = Math.min(...positions.map(p=>p.h));
      let maxH = Math.max(...positions.map(p=>p.h));
      let colspan = maxD-minD+1;
      let rowspan = maxH-minH+1;
      mainCell.colspan = colspan;
      mainCell.rowspan = rowspan;
      mainCell.merged = false;
      tableData[mainKey] = mainCell;
      positions.forEach(p=>{
        if(p.key!==mainKey){
          let cell = tableData[p.key]||{};
          cell.merged = true;
          tableData[p.key] = cell;
        }
      });
      localStorage.setItem('planTable', JSON.stringify(tableData));
      selectedCells = [];
      renderTable();
    }

    function setVibrate(){
      if('vibrate' in navigator){
        navigator.vibrate([450,100,450]);
        alert('已触发震动！');
      }else{
        alert('您的设备不支持震动。');
      }
    }

    // 闹钟功能
    function openAlarmModal() {
      document.getElementById('alarmModal').style.display = 'block';
      updateAlarmStatus();
    }
    
    function closeAlarmModal() {
      document.getElementById('alarmModal').style.display = 'none';
    }
    
    function saveAlarm() {
      const hour = parseInt(document.getElementById('alarmHour').value);
      const minute = parseInt(document.getElementById('alarmMinute').value);
      
      if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
        alert('请输入有效的时间！');
        return;
      }
      
      alarmTime = { hour, minute };
      localStorage.setItem('alarmTime', JSON.stringify(alarmTime));
      updateAlarmStatus();
      alert(`闹钟已设置为 ${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
      closeAlarmModal();
    }
    
    function clearAlarm() {
      alarmTime = null;
      localStorage.removeItem('alarmTime');
      updateAlarmStatus();
      alert('闹钟已清除');
      closeAlarmModal();
    }
    
    function loadAlarm() {
      const savedAlarm = localStorage.getItem('alarmTime');
      if (savedAlarm) {
        alarmTime = JSON.parse(savedAlarm);
        updateAlarmStatus();
      }
    }
    
    function updateAlarmStatus() {
      const statusEl = document.getElementById('alarmStatus');
      if (alarmTime) {
        statusEl.textContent = `当前闹钟: ${alarmTime.hour.toString().padStart(2, '0')}:${alarmTime.minute.toString().padStart(2, '0')}`;
      } else {
        statusEl.textContent = '未设置闹钟';
      }
    }
    
    function checkAlarm() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      
      // 检查整点提醒
      if (currentMinute === 0) {
        let player = document.getElementById('audioPlayer');
        if (ringSrc) player.play();
        if ('vibrate' in navigator) navigator.vibrate([300,100,300]);
      }
      
      // 检查自定义闹钟
      if (alarmTime && currentHour === alarmTime.hour && currentMinute === alarmTime.minute) {
        let player = document.getElementById('audioPlayer');
        if (ringSrc) player.play();
        if ('vibrate' in navigator) navigator.vibrate([500,200,500,200,500]);
        alert('闹钟时间到了！');
        
        // 清除单次闹钟
        alarmTime = null;
        localStorage.removeItem('alarmTime');
        updateAlarmStatus();
      }
    }
    
    // 每分钟检查一次闹钟
    setInterval(checkAlarm, 60000);

    function openSettings(){
      document.getElementById('settingsModal').style.display = 'block';
    }
    
    function closeSettings(){
      document.getElementById('settingsModal').style.display = 'none';
    }

    // 防止iOS缩放
    document.addEventListener('touchstart', function(event) {
      if (event.touches.length > 1) {
        event.preventDefault();
      }
    });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);

    // 初始化应用
    init();
  </script>
</body>
</html>